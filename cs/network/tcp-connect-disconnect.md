# TCP 연결과 연결 종료

`TCP`는 `UDP`와 다르게 데이터 통신을 위해 연결하는 과정과 연결을 끊는 과정이 수행됩니다. 이 과정을 각각 `3-way handshake/4-way handshake`라고 부릅니다.

## 3-Way Handshake (`TCP 연결`)

`TCP`통신을 위해 연결할 때 수행하는 작업을 `3-way handshake`라고 합니다. 연결은 `SYN`과 `ACK`패킷을 주고 받음으로써 수립됩니다. 동작은 아래와 같습니다.

> Client -`SYN`-> Server  
> Client <-`SYN/ACK`- Server  
> Client -`ACK`-> Server

먼저 클라이언트에서 서버로 접속 요청 `SYN`를 보냅니다. 이를 받은 서버는 연결 수락을 위해 `SYN`과 `ACK`를 보냅니다. 마지막으로 클라이언트에서 `ACK`를 보내면서 연결을 수립하게 됩니다.

또한 `SYN`와 `ACK`를 보낼 때 내부에 ISN(Initial Sequence Number)를 함께 보냅니다. 이는 각각의 `SYN`와 `ACK`가 어떤 클라이언트/서버의 패킷인지를 나타냅니다. 서로 이 시퀀스 번호를 주고받아 1:1 연결을 수립하기에 `2-way handshake`로 불충분합니다.

## 4-Way Handshake (`TCP 연결 해제`)

연결 해제도 연결과 비슷하게 서로 패킷을 주고 받으면서 수행됩니다. 여기서 오고 가는 패킷은 `FIN`과 `ACK`입니다.

> Client -`FIN`-> Server  
> Client <-`ACK`- Server  
> Client <-`FIN`- Server  
> Client -`ACK`-> Server

`3-way handshake`와 비슷하면서 다릅니다. 차이점은 서버에서 `SYN`과 `ACK`를 함께 보내던 연결과정과는 다르게 `ACK`와 `FIN`을 나눠서 보내고 있습니다. 구분 되는 이유는 사실 애초에 `4-way handshake`는 2개의 `2-way handshake`로 이루어져있기 때문이라고 이해하면 편합니다. 첫번째 `FIN`과 `ACK`는 클라이언트가 서버로의 연결을 끊겠다는 의미의 한 쌍이며, 그 이후의 `FIN`과 `ACK`는 반대로 서버가 클라이언트로의 연결을 끊겠다는 의미의 쌍 입니다. 따라서 서버에서 클라이언트로 `ACK/FIN`을 함께 보내지 않고 따로 보내는 것 입니다.

### TIME_WAIT

`4-way handshake`에서 클라이언트가 서버로부터 `FIN`을 받으면 클라이언트는 `TIME_WAIT`상태가 된 후 어느정도 시간을 대기한 후 연결을 완전히 해제합니다. 이 과정은 2가지의 주요한 이유로 존재합니다.

1. 지연 패킷이 발생했을 경우를 대비하여 연결을 조금 더 유지합니다. 클라이언트가 새로운 연결을 맺었을 때 이전 서버로부터 지연 패킷이 도달했고, 마침 시퀀스까지 같다면 데이터 무결성에 문제가 발생할 수 있기 때문입니다.

2. 서버의 온전한 연결 해제를 위해 연결을 조금 더 유지합니다. 만약 마지막 `ACK`패킷이 유실된다면 서버는 `LAST_ACK`상태에 빠지게 되며 `FIN`을 다시 전송하게 됩니다. 이런 과정을 통해 정상적으로 `ACK`가 서버에 도착하여 온전히 연결을 종료할 수 있게 됩니다.
